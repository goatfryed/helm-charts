suite: test deployment
templates:
  - deployment.yaml
  - configMap.appConfig.yaml
tests:
  - it: supports profiles as strings
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.profiles.active: "k8s, local, something"
      deployment.recreatePodStrategy: false
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].env[0]
          value:
            name: SPRING_PROFILES_ACTIVE
            value: "k8s, local, something"
  - it: supports profiles as arrays
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.profiles.active: [k8s, local, something]
      deployment.recreatePodStrategy: false
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].env[0]
          value:
            name: SPRING_PROFILES_ACTIVE
            value: "k8s, local, something"
  - it: calculates checksum over app config
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.config:
        profile1:
          values:
            foo: foo
        profile2:
          values:
            bar: bar
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum-app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
  - it: calculates checksum over app config with stable sort
    set:
      image:
        repository: goatfryed/spring-boot-echo
      spring:
        profiles:
          active: profile2, profile1
        config:
          profile2:
            values:
              bar: bar
          profile1:
            values:
              foo: foo
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum-app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
  - it: calculates checksum over active app config
    set:
      image.repository: goatfryed/spring-boot-echo
      spring:
        profiles:
          active: profile1, profile2
        config:
          profile1:
            values:
              foo: foo
          profile2:
            values:
              bar: bar
          profile3:
            values:
              foo: bar
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum-app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
  - it: supports environment variables
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.environmentVariable:
        FOO: BAR
        CHUCK: NORRIS
        MUTE: ""
        SILENT: ~
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: CHUCK
              value: NORRIS
            - name: FOO
              value: BAR
            - name: MUTE
              value: ""
  - it: omits managed environment variables
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.environmentVariable:
        SPRING_PROFILES_ACTIVE: test
        SPRING_CONFIG_LOCATION: /other/path
    asserts:
      - template: deployment.yaml
        notExists:
          path: spec.template.spec.containers[0].env
  - it: adds random label on podRecreationStrategy always
    set:
      image.repository: goatfryed/spring-boot-echo
      deployment.recreatePodStrategy: always
    asserts:
      - template: deployment.yaml
        matchRegex:
          path: spec.template.metadata.labels.release/roll-me
          pattern: "^0-"
      - template: deployment.yaml
        notExists:
          path: spec.template.metadata.labels.release/checksum-app-config
  - it: adds config checksum label on podRecreationStrategy values-changed
    set:
      image.repository: goatfryed/spring-boot-echo
      deployment.recreatePodStrategy: values-changed
      spring.config.profile.values.foo: bar
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum-app-config
          value: "d1794afd122dc6ec277a8994dfe58317e4426c4b31e7b1c4b4a906825a0521d7"
      - template: deployment.yaml
        notExists:
          path: spec.template.metadata.labels.release/roll-me
  - it: allows disable of recreation labels
    set:
      image.repository: goatfryed/spring-boot-echo
      deployment.recreatePodStrategy: ~
    asserts:
      - template: deployment.yaml
        notExists:
          path: spec.template.metadata.labels.release/checksum-app-config
      - template: deployment.yaml
        notExists:
          path: spec.template.metadata.labels.release/roll-me

