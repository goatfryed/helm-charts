suite: test chart
templates:
  - deployment.yaml
  - configMap.appConfig.yaml
tests:
  - it: injects application properties spring-container
    values:
      - "values/values.applicationYaml.yaml"
    asserts:
      - template: deployment.yaml
        matchSnapshot:
          path: spec.template.spec
      - template: configMap.appConfig.yaml
        matchSnapshot: {}
  - it: activates profiles automatically
    values:
      - "values/values.applicationYaml.yaml"
    templates:
      - deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0]
          value:
            name: SPRING_PROFILES_ACTIVE
            value: "profile1, profile2, profile3, profile4"
  - it: mounts configuration values
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.config.userConfig.values:
        foo: bar
        how:
          are: you
    asserts:
      - template: deployment.yaml
        matchSnapshot:
          path: spec.template.spec
  - it: mounts referenced configMaps
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.config.userConfig.configMap.name: user-defined-config-map
    asserts:
      - template: deployment.yaml
        matchSnapshot:
          path: spec.template.spec
  - it: mounts referenced secrets
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.config.userConfig.secret.name: user-defined-secret
    asserts:
      - template: deployment.yaml
        matchSnapshot:
          path: spec.template.spec
  - it: calculates checksum over app config
    set:
      image.repository: goatfryed/spring-boot-echo
      spring.config:
          profile1:
            values:
              foo: foo
          profile2:
            values:
              bar: bar
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum/app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
  - it: calculates checksum over app config with stable sort
    set:
      image:
        repository: goatfryed/spring-boot-echo
      spring:
        profiles:
          active: profile2, profile1
        config:
          profile2:
            values:
              bar: bar
          profile1:
            values:
              foo: foo
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum/app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
  - it: calculates checksum over active app config
    set:
      image.repository: goatfryed/spring-boot-echo
      spring:
        profiles:
          active: profile1, profile2
        config:
          profile1:
            values:
              foo: foo
          profile2:
            values:
              bar: bar
          profile3:
            values:
              foo: bar
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.metadata.labels.release/checksum/app-config
          value: 3d9a1b9ff8249efd74f1fd196e6e4f5bf7d51fc4dcfb855844b380ce9e311c31
